SHELL=/bin/bash

VENV=venv
VACT=$(VENV)/bin/activate
PR_ACT="Enter 'source $(VACT)' or 'source $(VACT).csh' to activate the virtual env"

.PHONY: all clean clean-files clean-notebooks clean-tests docs install tests

install:
	@if test ! -d $(VENV); then \
	  echo "Making virtual environment in $(VENV)"; \
	  python -m virtualenv $(VENV); \
	  set -e; \
	else \
	  echo "You already have the virtual environment $(VENV)"; \
	fi; \
	$(VENV)/bin/pip install --upgrade pip; \
	$(VENV)/bin/pip install -r requirements.txt; \
	$(VENV)/bin/pip install -e .[jupyter]; \
	echo $(PR_ACT)

all: clean docs tests

docs: install
	@$(VENV)/bin/tox -e docs

tests:
	@tests/run_all_tests.sh

clean:
	@make --no-print-directory clean-notebooks; \
	make --no-print-directory clean-files

clean-files:  clean-tests
	@echo "Cleaning build files.."; \
	rm -rf build; \
	rm -rf sina.egg-info $(VENV); \
	find . -name "*.pyc" -exec rm -f {} \; >& /dev/null; \
	find . -name __pycache__ -exec rm -rf {} \; >& /dev/null; \

# It is assumed any version/installation of Jupyter will properly remove outputs
# and that we do not want to have to [re-]install the virtual environment just
# to remove outputs from notebooks.
clean-notebooks:
	@echo "Removing any outputs from notebooks.."; \
	NOTEBOOKS=`find ../examples -name "*.ipynb" -print`; \
	JUPYTER_EXE=`which jupyter 2> /dev/null`; \
	NBCONVERT="--ClearOutputPreprocessor.enabled=True --log-level WARN --inplace"; \
	if test -f $(VENV)/bin/jupyter; then \
	  $(VENV)/bin/jupyter nbconvert $$NBCONVERT $$NOTEBOOKS; \
	elif test -n "$$JUPYTER_EXE" && test -f $$JUPYTER_EXE; then \
	  $$JUPYTER_EXE nbconvert $$NBCONVERT $$NOTEBOOKS; \
	else \
	  echo "Sina must be installed to clean notebooks.  Run 'make'."; \
	fi

# The tests target currently builds the docs so remove them too.
clean-tests:
	@echo "Cleaning files generated by tests target.."; \
	rm -rf .tox fake.sqlite nosetests*.xml*; \
	rm -rf docs/build docs/source/generated_docs; \
	rm -rf tests/test_venv; \
	rm -rf tests/run_tests
